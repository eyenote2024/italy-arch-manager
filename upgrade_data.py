import json
import os
import urllib.parse

def generate_maps_url(name, city):
    query = f"{name} {city} Italy"
    return f"https://www.google.com/maps/search/?api=1&query={urllib.parse.quote(query)}"

# 根據 MD 內容精煉出的參觀重點映射 (手動精選最精華部分)
HIGHLIGHTS_MAP = {
    "milan_01": ["壯麗哥德式中殿", "免稅大理石 AUF 標記 (米蘭俚語由來)"],
    "milan_02": ["中央八角形廣場玻璃穹頂", "公牛馬賽克轉圈 (祈求好運)"],
    "milan_03": ["費拉雷特塔樓", "通往聖母教堂的秘密地道"],
    "milan_04": ["空中花園綠建築", "45,000 隻瓢蟲自然防蟲"],
    "milan_05": ["達文西《最後的晚餐》真跡", "二戰轟炸下的奇蹟之牆"],
    "milan_06": ["紅色絲絨包廂與水晶吊燈", "18世紀貴族在包廂煮飯的趣聞"],
    "milan_07": ["現代主義摩天大樓外觀", "屋頂的聖母複製品 (Madonnina)"],
    "milan_08": ["24K 金箔外牆 (鬼屋)", "魏斯·安德森設計的 Bar Luce 咖啡廳"],
    "milan_09": ["Hadid 扭曲塔、Isozaki 直塔天際線", "老貿易展覽館舊址翻新"],
    "milan_10": ["古典雙層拱門中庭", "拿破崙銅像與秘密植物園"],
    "milan_11": ["雙高度鐘塔 (修士塔與教士塔)", "惡魔之柱上的兩個孔洞"],
    "milan_12": ["新中世紀風格名人堂入玄關", "金巴利家族墓陵的《最後的晚餐》"],
    "milan_13": ["修女堂滿室壁畫 (米蘭的西斯汀)", "隱修修女專用的分隔牆"],
    
    "venice_01": ["金色敘事性馬賽克圓頂", "隱藏在豬肉堆下的聖人遺體傳說"],
    "venice_02": ["大會議廳《天堂》巨作", "公佈死刑的粉紅石柱與獅子之口"],
    "venice_03": ["單弧石橋景觀", "與惡魔交易的傳說"],
    "venice_04": ["八角形巴洛克大圓頂", "地基下的 100 萬根木樁"],
    "venice_05": ["鳳凰浴火重生的紅金劇場", "1996 年人為縱火的小故事"],
    "venice_06": ["白色封閉式嘆息橋", "囚犯最後的陽光與卡薩諾瓦越獄"],
    "venice_07": ["大理石雕花外面", "法蘭凱提男爵撒骨灰守護藝術"],
    "venice_08": ["丁托列托史詩畫作", "建築師靠「先斬後奏」得標的趣事"],
    "venice_09": ["馬里尼雕塑與大運河露台", "佩姬與她 14 隻狗狗的墓地"],
    "venice_10": ["多層圓弧拱廊螺旋梯", "可以騎馬直達臥室的梯塔設計"],
    "venice_11": ["帕拉底奧式教堂立面", "比聖馬可更優雅的登頂視角"],
    "venice_12": ["巨型石雕獅子城門", "獅子身上的維京符文遺址"],
    "venice_13": ["羅可可紅絲絨包廂", "卡薩諾瓦當年的獵豔總部"],
    "venice_14": ["隱匿巷弄與窄橋流水", "感受威尼斯最靜謐的靈魂"],
    "venice_15": ["提香《聖母升天》祭壇畫", "大師長眠處與心臟分離的紀念碑"],

    "florence_01": ["布魯內萊斯基紅磚大圓頂", "曾因封不了頂淋雨百年的趣聞"],
    "florence_02": ["綠白大理石幾何立面", "但丁受洗地與救人往事"],
    "florence_03": ["阿諾河上的珠寶金匠鋪", "希特勒唯一不忍炸毀的老橋"],
    "florence_04": ["堡疊式石牆與非對稱鐘塔", "達文西與米開朗基羅的壁畫競賽地"],
    "florence_05": ["U 字型中庭框景", "原本是給美第奇家族專用的貴族辦公室"],
    "florence_06": ["粗曠石塊砌成的壯闊宮殿", "碧提家族為炫富而蓋到破產的故事"],
    "florence_07": ["絲柏大道與環湖水池", "石窟中融化感十足的奇詭雕塑"],
    "florence_08": ["米開朗基羅長眠之處", "司湯達曾在此因審美過度暈倒"],
    "florence_09": ["粗糙未飾面的外牆對比精雅內部", "教宗挪用建築經費去打仗的逸事"],
    "florence_10": ["大衛像真跡圓頂大廳", "大衛像其實有一點「鬥雞眼」的秘密"],
    "florence_11": ["數學美感幾何立面", "全世界最古老的製藥院"],
    "florence_12": ["奧特拉諾區暖黃調立面", "因地主拒遷而被迫轉向 180 度的教堂"],
    "florence_13": ["馬薩喬早期文藝復興壁畫", "米開朗基羅在此打架被打斷鼻樑"],
    "florence_14": ["青銅大衛複製品與城景", "19 世紀為貴族駕車兜風而建的廣場"],
    "florence_15": ["切利尼《珀耳修斯》青銅雕刻", "藝術家丟入家裡錫盤救回作品的熱血故事"],
    "florence_16": ["纖細鑲嵌的三色鐘塔", "畫家設計的 84 公尺藝術高峰"],

    "rome_01": ["夕陽下的弧形石灰華外牆", "古代注水海戰與百萬野獸死亡之地"],
    "rome_02": ["全世界最大無筋混凝土圓頂", "陽光灑落圓眼及其惡魔撞破的傳說"],
    "rome_03": ["大海神尼普頓噴泉劇場", "每日 3000 歐元硬幣的慈善用途"],
    "rome_04": ["貝尼尼青銅華蓋與高穹頂", "圓頂大到裝得下整座自由女神像"],
    "rome_05": ["天使橋與圓柱堡壘景觀", "直通梵蒂岡的教宗逃命秘密通道"],
    "rome_06": ["廢墟遺址中的農神廟石柱", "曾被埋入土中變成「牧牛場」的歷史"],
    "rome_07": ["蝴蝶形西班牙大階梯", "現場嚴禁飲食與坐臥的維護規定"],
    "rome_08": ["傘狀松樹林環繞的白色別墅", "創辦人曾派兵強行「搶奪」名畫的軼事"],
    "rome_09": ["長橢圓體育場地坪線條", "腳下就是古羅馬賽跑跑道的鬼魂"],
    "rome_10": ["巨大白色大理石「打字機」", "羅馬人眼中的突兀大蛋糕"],
    "rome_11": ["天頂金箔地圖長廊", "米開朗基羅畫到長贅瘤的抱怨信"],
    "rome_12": ["米開朗基羅設計的幾何星形廣場", "權力從論壇移向梵蒂岡的符號隱喻"],
    "rome_13": ["羅馬版「凡爾賽鏡廳」", "由現任親王錄製的家族八卦語音導覽"],
    "rome_14": ["12 世紀「生命之樹」馬賽克", "四層歷史文化堆疊的「義式千層麵」"],
    "rome_15": ["切拉西禮拜堂卡拉瓦喬巨作", "「馬屁股也是上帝的駿馬」經典回覆"],
    "rome_16": ["Contarelli 禮拜堂《聖馬太蒙召》", "畫中神光與真實窗光完美融合的神技"],
}

DATA_DIR = "src/data"
for filename in os.listdir(DATA_DIR):
    if filename.endswith(".json"):
        city_name_en = filename.replace(".json", "")
        city_name_tw = {
            "milan": "米蘭",
            "florence": "佛羅倫斯",
            "venice": "威尼斯",
            "rome": "羅馬"
        }.get(city_name_en, city_name_en)
        
        path = os.path.join(DATA_DIR, filename)
        with open(path, 'r', encoding='utf-8') as f:
            data = json.load(f)
            
        for item in data:
            item_id = item.get("id")
            name_tw = item.get("name")
            
            # 生成地圖連結
            item["google_maps_url"] = generate_maps_url(name_tw, city_name_tw)
            
            # 插入參觀重點
            if item_id in HIGHLIGHTS_MAP:
                item["visit_highlights"] = HIGHLIGHTS_MAP[item_id]
            else:
                item["visit_highlights"] = ["請參閱現場解說牌"]
                
        with open(path, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2)

print("✅ 所有城市資料已成功補完地圖與攻略資訊！")
